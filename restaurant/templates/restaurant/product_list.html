{% extends "restaurant/base.html" %}

{% block title %}Gerenciar Produtos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">Gerenciar Produtos</h2>
    {# Botão com classe e data-url para o JavaScript #}
    <button type="button" class="btn btn-primary btn-add"
            data-url="{% url 'restaurant:adicionar_produto' %}">
        + Adicionar Produto
    </button>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="row">
            {% for produto in produtos %}
            <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
                <div class="card card-product h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold">{{ produto.nome }}</h5>
                        <p class="card-text text-muted small flex-grow-1">{{ produto.descricao }}</p>
                        <p class="card-text fs-4 fw-bold text-primary mb-3">R$ {{ produto.preco|stringformat:".2f" }}</p>
                        <div class="card-product-actions mt-auto">
                             {# Botões com classes e data-url para o JavaScript #}
                            <button type="button" class="btn btn-sm btn-outline-secondary btn-edit"
                                    data-url="{% url 'restaurant:editar_produto' produto.pk %}">
                                Editar
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete"
                                    data-url="{% url 'restaurant:deletar_produto' produto.pk %}">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5">
                <p class="text-muted">Nenhum produto cadastrado.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{# Estrutura do Modal que será manipulada pelo JavaScript #}
<div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div id="modal-content-wrapper">
        {# O conteúdo dos templates parciais será carregado aqui #}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const modalElement = document.getElementById('actionModal');
    const modal = new bootstrap.Modal(modalElement);
    const modalContentWrapper = document.getElementById('modal-content-wrapper');

    // Função para abrir o modal com conteúdo de uma URL
    const openModal = (url) => {
        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalContentWrapper.innerHTML = html;
                modal.show();
                handleFormSubmission(); // Adiciona o listener ao novo formulário
            });
    };

    // Adiciona listener para os botões de Adicionar
    document.querySelectorAll('.btn-add').forEach(button => {
        button.addEventListener('click', () => openModal(button.dataset.url));
    });

    // Adiciona listener para os botões de Editar
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', () => openModal(button.dataset.url));
    });

    // Adiciona listener para os botões de Deletar
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', () => openModal(button.dataset.url));
    });

    // Função para lidar com o envio do formulário dentro do modal
    const handleFormSubmission = () => {
        const form = modalContentWrapper.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault(); // Impede o envio tradicional
                
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        // O Django CSRF token precisa ser enviado
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.hide();
                        location.reload(); // Recarrega a página em caso de sucesso
                    } else {
                        // Opcional: Lidar com erros de validação
                        console.error('Erro no formulário:', data.errors);
                        alert('Ocorreu um erro. Verifique os dados e tente novamente.');
                    }
                });
            });
        }
    };
});
</script>
{% endblock %}